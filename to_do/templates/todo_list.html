{% extends 'base.html' %}
{% block page_title %}Home Page{% endblock %}


{% block icon_cards %}
<!-- Icon Cards - will display icons at the top of the home page and count issues and features  -->
<div class="row margin_top">

    <!-- Icon card for issues -->
    <div class="col-xl-6 col-sm-6 mb-3">
        <div class="card text-white bg-primary o-hidden h-100">

            <div class="card-body">
                <div class="card-body-icon">
                    <i class="fa fa-fw fa-comments"></i>
                </div>
                    
                <!-- Pending issues count -->
                {% for not_done in not_done_issues_count %}
                <div class="mr-5">{{not_done}} Pending Issues</div>
                {% endfor %}

            </div> <!-- Close card-body class -->

        </div> <!-- Close card class -->
    </div> <!-- Close col class -->

    <!-- Icon card for features -->
    <div class="col-xl-6 col-sm-6 mb-3">

        <div class="card text-white bg-success o-hidden h-100">
            <div class="card-body">
                <div class="card-body-icon">
                    <i class="fa fa-fw fa-list"></i>
                </div>
                
                <!-- Count feature requests and those completed -->
                <div class="mr-5">{{pending_features_to_do_count}} Feature Requests</div>
                {% if features_in_progress_count == 1 %}
                    <div class="mr-5">{{features_in_progress_count}} Feature in progress</div>
                {% else %}
                    <div class="mr-5">{{features_in_progress_count}} Features in progress</div>
                {% endif %}
            </div>
            
        </div> <!-- Close card class -->
    </div> <!-- Close col class -->
</div> <!-- Close row -->
{% endblock %}

{% block body_text %}

<!-- Displays relevant messages depending on user actions -->
<div class="container margin_bottom">
    <div class="row">
        <div class="col-sm-12">
            {% if messages %}
                {% for message in messages %}
                    {{message}}
                {% endfor %}
            {% endif %}
        </div>
    </div>
</div>

<div class="container margin_top">

    <div class="row">
        <div class="col-sm-12 col-md-2">
            <a class="custom_a" href="{% url 'home' %}">
                <h4 class="active_page">Open Cases</h4>
            </a>
        </div>
        <div class="col-sm-12 col-md-4">
            <a class="custom_a" href="{% url 'closed_issues_and_features' %}">
                <h4>Closed Cases</h4>
            </a>
        </div>
        
        <!-- Check if the user is logged in. They can only purchase a feature 
            ticket if they are, otherwise they'll be sent an alert to login -->
        {% if user.is_authenticated %}
            <div class="col-sm-12 col-md-2">
                <a class="custom_a" href="{% url 'new_issue' %}">
                    <h5><button class="btn btn-primary">New Issue Request</button></h5>
                </a>
            </div>
        
            <div class="col-sm-12 col-md-4">
                <a class="custom_a" href="{% url 'checkout' %}">
                    <h5><button class="btn btn-primary">Buy New Feature Request</button></h5>
                </a>
            </div>

        {% else %}
            <div class="col-sm-12 col-md-2">
                <h5><button class="btn btn-primary login_to_add_issue">New Issue Request</button></h5>
            </div>

            <div class="col-sm-12 col-md-4">
                <h5><button class="btn btn-primary login_to_buy">Buy New Feature Request</button></h5>
            </div>

        {% endif %}
    </div>
</div>

<!-- Table for issues and separate table for features -->
<div class="container">
    <div class="row">
        <div class="col-sm-12">
            
            <table class="table table-hover">
                <thead class="thead-dark">
                    <tr>
                        <th scope="col">Open Issues</th>
                        <th scope="col">Status</th>
                        <th scope="col">Upvotes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in items %}

                    <tr>
                        <!-- Nothing is displayed if an issue is marked as done -->
                        {% if item.done %}

                        <!-- Look for all pending issues -->
                        {% else %}

                            <!-- Check if a user is logged in. If they are, they can upvote an issue -->
                            {% if user.is_authenticated %}
    
                                <td>
                                    <p>{{item.Issue | title }}</p>
                                    <p><b>added:</b> {{ item.date_created }}</p>
                                </td>
        
                                <td>In Progress</td>

                                <td>
                                    <!-- This is the code that allows a logged in user to upvote an issue -->
                                    <form method="POST" action="toggle/{{ item.id }}">{% csrf_token %}<button
                                            class="plain_button border-radius-button like_button"><i
                                                class="fa fa-thumbs-o-up"></i></button>{{ item.likes.count }}</form>
                                </td>
    
                            <!-- If the user isn't logged in they will be sent an alert telling them to log in before they can upvote an issue -->
                            {% else %}
                            
                                <td>
                                    <p>{{item.Issue | title }}</p>
                                    <p><b>added:</b> {{ item.date_created }}</p>
                                </td>
        
                                <td>In Progress</td>
        
                                <!-- This is the code that has an extra class which will activate an alert to login
                                before a user can upvote an issue -->
                                <td>
                                    <button class="plain_button border-radius-button login_to_like like_button"><i
                                            class="fa fa-thumbs-o-up"></i></button>{{ item.likes.count }}
                                </td>
    
                            {% endif %}

                        {% endif %}
                    </tr>
                    {% empty %}
                    <p>No issues, for now...</p>
                    {% endfor %}
                </tbody>
            </table>
            
        </div> <!-- closing col-sm class -->
    </div> <!-- closing row  -->
</div> <!-- Closing container for issues table -->

<!-- Feature requests table -->
<div class="container">
    <div class="row">
        <div class="col-sm-12">
            
            <table class="table table-hover">
                <thead class="thead-dark">
                    <tr>   
                        <th scope="col">Open Feature Requests</th>
                        <th scope="col">££ got/££ needed</th>
                        <th scope="col">Upvotes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for feature in features %}

                    <tr>
                        <!-- Features that are completed are ignored -->
                        {% if feature.done %}

                        <!-- Pending features are displayed here -->
                        {% else %}
                        
                        <!-- Check if a user is logged in. If they are they can upvote a feature -->
                        {% if user.is_authenticated %}

                            {% if feature.name in features_in_progress %}

                            {% else %}
                            <td>
                                <p>{{feature.name | title }}</p>
                                <p><b>added:</b> {{ feature.date_created }}</p>
                                <p>Upvote Cost: £ {{feature.like_cost}}</p>
                            </td>
                            
                            <td>{{feature.money_received}}/{{feature.amount_needed}}</td>

                            <td>
                                <!-- The code for upvoting a feature when logged in -->
                                <form method="['POST', 'GET']" action="upvote_checkout/{{ feature.id }}">
                                
                                    {% csrf_token %}
                                    <button class="plain_button border-radius-button like_button" type="submit">
                                        <i class="fa fa-thumbs-o-up"></i>
            
                                    </button>
                                
                                </form>
                                            {{ feature.likes.count }}
                            </td>

                            {% endif %}

                        <!-- If the user isn't logged in they will be given an alert telling them to log in before
                        they can upvote a feature -->
                        {% else %}
                            {% if feature.name in features_in_progress %}

                            {% else %}
                            <td>
                                <p>{{feature.name | title }}</p>
                                <p><b>added:</b> {{ feature.date_created }}</p>
                            </td>

                            <td>{{feature.money_received}}/{{feature.amount_needed}}</td>

                            <td>
                                <!-- Code with an extra class that will pop up an alert telling users to login before upvoting -->
                                <button class="plain_button border-radius-button login_to_like like_button"><i
                                        class="fa fa-thumbs-o-up"></i></button>{{ feature.likes.count }}
                            </td>
                            {% endif %}

                        {% endif %}

                        {% endif %}
                    </tr>
                    {% empty %}
                    <p>No features, for now...</p>
                    {% endfor %}
                </tbody>
            </table>
            
        </div> <!-- closing sm class -->
    </div> <!-- closing row -->
</div> <!-- Closing container for feature requests table -->

<!-- Table for features in progress -->
<div class="container margin_top">
    <table class="table table-hover">
        <h2>Features In Progress</h2>
        <thead class="thead-dark">
            <tr>
                <th scope="col"></th>
                <th scope="col">Feature</th>
                <th scope="col">Handler</th>
                <th scope="col">Expected completion date</th>
            </tr>
        </thead>
        <tbody>
            {% for feature_in_progress in features %}

                <!-- Display features that have reached their monetary requirement -
                        those will be the ones in progress -->
                {% if feature_in_progress.name in features_in_progress %}
                    <tr>
                        <th scope="row">1</th>
                        <td>{{feature_in_progress.name}}</td>
                        <td>@admin</td>
                        <td>TBC</td>
                    </tr>
                
                <!-- Ignore features that haven't reached the required amount of money -->
                {% else %}
                {% endif %}
            {% empty %}
                <p>No new features Implemented, for now...</p>
            {% endfor %}
        </tbody>
    </table>
</div> <!-- Closing container for features in progress table -->

<!-- Scroll to Top Button-->
<div class="container margin_top">
    <a class="rounded" href="#page-top">
        <i class="fa fa-arrow-circle-up"></i>
    </a>
</div>

{% endblock %}


